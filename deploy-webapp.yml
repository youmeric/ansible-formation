---
- name: "ğŸš€ DÃ©ploiement WebApp avec RÃ´les et SÃ©curitÃ©"
  hosts: webservers
  become: yes
  gather_facts: yes
  
  vars:
    # Personnalisation pour ce dÃ©ploiement
    app_name: "Formation DevOps"
    app_version: "3.0.0"
    admin_email: "formation@ansible.local"
  
  pre_tasks:
    - name: "ğŸ” VÃ©rification initiale"
      ping:
      register: ping_result
      
    - name: "ğŸ“Š Informations du serveur"
      debug:
        msg: |
          ğŸ–¥ï¸ Serveur: {{ inventory_hostname }}
          ğŸ§ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ—ï¸ Architecture: {{ ansible_architecture }}
          ğŸŒ IP: {{ ansible_default_ipv4.address | default('Non dÃ©finie') }}
      
    - name: "â³ Attente serveur prÃªt"
      wait_for_connection:
        timeout: 30
  
  roles:
    - role: webapp
      tags: [webapp]
  
  post_tasks:
    - name: "ğŸ§ª Test nginx Ã©coute"
      wait_for:
        port: "{{ app_port }}"
        host: "127.0.0.1"
        timeout: 10
      register: nginx_port_test
      
    - name: "ğŸ§ª Test page web"
      uri:
        url: "http://127.0.0.1:{{ app_port }}"
        method: GET
        status_code: 200
      register: webapp_test
      retries: 3
      delay: 2
      
    - name: "ğŸ“‹ RÃ©sumÃ© final"
      debug:
        msg: |
          ğŸ‰ DÃ‰PLOIEMENT TERMINÃ‰ !
          ========================
          ğŸ“± Application: {{ app_name }} v{{ app_version }}
          ğŸ–¥ï¸ Serveur: {{ inventory_hostname }}
          ğŸŒ Test local: {{ webapp_test.status == 200 | ternary('âœ… SuccÃ¨s', 'âŒ Ã‰chec') }}
          
          ğŸŒ URLs pour tester:
          - web1: http://localhost:8081
          - web2: http://localhost:8082
          
          ğŸ“ Fichiers: {{ nginx_document_root }}

