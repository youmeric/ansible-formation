
# =========================================
#  Ã‰TAPE 1 : Messages et prÃ©paration
# =========================================

- name: "[INFO] DÃ©but installation {{ app_name }}"
  debug:
    msg: "ğŸš€ Installation de {{ app_name }} version {{ app_version }} sur {{ inventory_hostname }}"

- name: "ğŸ“¦ Mise Ã  jour du cache APT"
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: [packages]

# =========================================
#  Ã‰TAPE 2 : Installation (Ubuntu 24.04)
# =========================================

- name: "ğŸŒ Installation de nginx"
  apt:
    name: nginx
    state: present
  notify: start nginx
  tags: [packages, nginx]

- name: "ğŸ˜ Installation de PHP {{ php_version }}"
  apt:
    name: "{{ php_packages }}"
    state: present
  notify: start php-fpm
  tags: [packages, php]

# =========================================
#  Ã‰TAPE 3 : CrÃ©ation des rÃ©pertoires
# =========================================

- name: "ğŸ“ CrÃ©ation du rÃ©pertoire de l'application"
  file:
    path: "{{ nginx_document_root }}"
    state: directory
    owner: "{{ nginx_user }}"
    group: "{{ nginx_user }}"
    mode: '0755'
  tags: [directories]

- name: "ğŸ“ CrÃ©ation du rÃ©pertoire logs"
  file:
    path: "{{ nginx_document_root }}/logs"
    state: directory
    owner: "{{ nginx_user }}"
    group: "{{ nginx_user }}"
    mode: '0755'
  tags: [directories]

# =========================================
#  Ã‰TAPE 4 : Secrets (RÃ©vision Vault)
# =========================================

- name: "ğŸ” Chargement des secrets"
  include_vars: "{{ playbook_dir }}/secrets.yml"
  tags: [secrets]

# =========================================
#  Ã‰TAPE 5 : DÃ©ploiement application
# =========================================

- name: "ğŸ  DÃ©ploiement de la page PHP principale"
  template:
    src: index.php.j2
    dest: "{{ nginx_document_root }}/index.php"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_user }}"
    mode: '0644'
  tags: [app, deploy]

- name: "ğŸ¨ DÃ©ploiement du CSS"
  copy:
    src: app.css
    dest: "{{ nginx_document_root }}/app.css"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_user }}"
    mode: '0644'
  tags: [app, deploy]

# =========================================
#  Ã‰TAPE 6 : Configuration nginx
# =========================================

- name: "âš™ï¸ Configuration du virtual host nginx"
  template:
    src: nginx-vhost.j2
    dest: "/etc/nginx/sites-available/{{ app_name | lower | replace(' ', '-') }}"
    backup: yes
  notify: reload nginx
  tags: [nginx, config]

- name: "ğŸ”— Activation du virtual host"
  file:
    src: "/etc/nginx/sites-available/{{ app_name | lower | replace(' ', '-') }}"
    dest: "/etc/nginx/sites-enabled/{{ app_name | lower | replace(' ', '-') }}"
    state: link
  notify: reload nginx
  tags: [nginx, config]

- name: "âŒ DÃ©sactivation du site par dÃ©faut"
  file:
    path: "/etc/nginx/sites-enabled/default"
    state: absent
  notify: reload nginx
  tags: [nginx, config]

# =========================================
#  Ã‰TAPE 7 : DÃ©marrage des services
# =========================================

- name: "ğŸŒ DÃ©marrage de nginx"
  service:
    name: nginx
    state: started
    enabled: yes
  tags: [services]

- name: "ğŸ˜ DÃ©marrage de PHP-FPM"
  service:
    name: "php{{ php_version }}-fpm"
    state: started
    enabled: yes
  tags: [services]

- name: "[SUCCESS] âœ… Application dÃ©ployÃ©e avec succÃ¨s"
  debug:
    msg: "ğŸ‰ {{ app_name }} est accessible sur le port {{ app_port }}"


# =========================================
#  Ã‰TAPE 8 : Monitoring basique
# =========================================
- name: "ğŸ“Š DÃ©ploiement script monitoring"
  template:
    src: ../files/monitor.sh
    dest: /usr/local/bin/webapp-monitor.sh
    mode: '0755'
  tags: [monitoring]